# AUTOGENERATED! DO NOT EDIT! File to edit: ../notebooks/20_computing-cielab-values-from-rgb.ipynb.

# %% auto 0
__all__ = ['read_target_data', 'RGBs_to_LABs', 'compare']

# %% ../notebooks/20_computing-cielab-values-from-rgb.ipynb 9
import colour 
import pandas as pd
import numpy as np 

# %% ../notebooks/20_computing-cielab-values-from-rgb.ipynb 10
def read_target_data(target_txt_file, verbose=False): 
    '''Read measured CIELAB values for specific Colorchecker target. '''
    
    # just print the contents of the target data file...  
    if verbose: 
        with open(target_txt_file, 'r') as fh: 
            lines = fh.readlines()    
        for l in lines: 
            print(l, end='') 

    # TODO: make more robust for other file formats 
    target_df = pd.read_csv(target_txt_file, skiprows=22, delimiter='\t', decimal=',', nrows=140, 
                     usecols=[1, 2, 3, 4], names=['PATCH', 'TARGET_L', 'TARGET_A', 'TARGET_B'])
    target_df.set_index('PATCH', inplace=True) 

    return target_df 


def RGBs_to_LABs(RGBs): 
    '''Convert RGB values dataframe into CIELAB values dataframe assuming ECI_RGB_v2 colour space. '''

    # dataframe to array 
    index = RGBs.index 
    RGBs = RGBs.values

    ECI_RGB_V2 = colour.models.RGB_COLOURSPACE_ECI_RGB_V2
    ECI_RGB_V2.use_derived_transformation_matrices = True 
    illuminant = ECI_RGB_V2.whitepoint # D50 

    XYZs = colour.RGB_to_XYZ(RGBs, ECI_RGB_V2, apply_cctf_decoding=True)
    LABs = colour.XYZ_to_Lab(XYZs, illuminant=illuminant) 

    # array to dataframe 
    LAB_df = pd.DataFrame(LABs, index=index, columns=['TIF_L', 'TIF_A', 'TIF_B'])

    return LAB_df


def compare(target_LABs, tif_LABs):

    # set global display options 
    #pd.options.display.precision = 2
    pd.options.display.float_format = '{:,.2f}'.format 
    both = pd.concat([target_LABs, tif_LABs], axis=1)

    dE_1976 = colour.delta_E(target_LABs.values, tif_LABs.values, method='CIE 1976') #, 'CIE 1994', 'CIE 2000')
    dE_2000 = colour.delta_E(target_LABs.values, tif_LABs.values, method='CIE 2000') #, 'CIE 1994', 'CIE 2000') 
    
    both['dE_1976'] = dE_1976
    both['dE_2000'] = dE_2000
    
    return both    
